# ------------------------------------------------------------------------------
# PROGRAMMING ENVIRONMENT SECTION (PE)
#
# The PE section follows the syntax: <pe_name>_<stack_name>_<package_name>. for
# example: intel_stable_compiler. There is a parent child schema that must be
# respected. The metadata key is ignored for this purpose. The core PE only has
# one information and does not follow the same schema. Any key under the
# <package_name> will be seen as a filter or it will be ignored. In the future
# we may need to introduce a stack key and a dependencies key for the case where
# we want to compile the compiler or stack libraries with GPU support. For now,
# the core_compiler should have this name (this means 'core' key and 'compiler'
# for subkey. We can also set section:core for the core PE.
core:
  metadata:
    section: core
  compiler: <core_compiler>

gcc:
  metadata:
    section: pe
  stable:
    compiler: gcc@11.3.0
    mpi:
      infiniband: openmpi@4.1.3 fabrics=ucx +pmi schedulers=slurm ~memchecker ~rsh ^hwloc ~libxml2
      infiniband_gdrcopy: openmpi@4.1.3 +cuda cuda_arch=<cuda_arch> fabrics=ucx +pmi schedulers=slurm ~memchecker ~rsh ^hwloc ~libxml2
      ethernet_roce: openmpi@4.1.3 fabrics=ucx +pmi schedulers=slurm ~memchecker ~rsh ^hwloc ~libxml2
      ethernet: openmpi@4.1.3 fabrics=ucx +pmi schedulers=slurm ~memchecker ~rsh ^hwloc ~libxml2
    blas: openblas@0.3.20 threads=none +locking
    blas_parallel: openblas@0.3.20 threads=openmp +locking
    python3: python@<python3> +tkinter +optimizations ~debug +ssl ~libxml2 ^tk +xft+xss
    python2: python@2.7.18 +tkinter ~debug
    gpu:
      nvidia: cuda@<default_cuda_version>
      none: ""

intel:
  metadata:
    section: pe
  filters: ['cloud = none']
  stable:
    compiler: intel@2021.6.0
    compiler_spec: intel-oneapi-compilers-classic@2021.6.0
    mpi:
      infiniband: intel-oneapi-mpi
      infiniband_gdrcopy: intel-oneapi-mpi ~external-libfabric
      ethernet_roce: intel-oneapi-mpi
    blas: intel-oneapi-mkl
    blas_parallel: intel-oneapi-mkl
    python3: python@<python3> +tkinter +optimizations ~debug +ssl
    python2: python@2.7.18 +tkinter ~debug
    gpu:
      nvidia: cuda@<default_cuda_version>
      none: ""

nvhpc:
  metadata:
    section: pe
  filters: ['gpu = nvidia']
  stable:
    compiler: nvhpc@23.3
    compiler_spec: nvhpc@23.3 +mpi +blas +lapack
    mpi: ""
    blas: ""
    blas_parallel: ""
    gpu: cuda@<default_cuda_version>

# CORE -------------------------------------------------------------------------
#
#
# ------------------------------------------------------------------------------
core_packages:
  metadata: {section: packages }
  pe: [core]
  packages:
    - autoconf
    - automake
    - cmake:
        variants: +ncurses +ownlibs
        default:
          variants: +ownlibs ~ncurses ~qt
        dependencies:
          - openssl@<openssl_version>
    - emacs +tls
    - fastqc
    - fio
    - git
    - git-lfs
#    - i7z
    - intel-oneapi-advisor
    - intel-oneapi-inspector
    - intel-oneapi-vtune
    - libjpeg-turbo
    - libpng
    - libtool
    - lmod
    - m4
    - neovim@0.9.0
    - parallel
    - perl:
        default: { version: 5.32.0 }
    - picard
    - pmix:
        default:
          buildable: False
        externals:
          - spec: pmix@<pmix_version>
            prefix: /usr
    - rclone
    - sbt
    - sratoolkit
    - subversion
    - tar
    - tmux
    - trimmomatic
    - xclip

# CORE (STABLE COMPILER) -------------------------------------------------------
#
#
# ------------------------------------------------------------------------------
core_packages_stable:
  metadata: {section: packages }
  pe: [gcc_stable]
  packages:
    - flex:
        default: { version: 2.6.4 }

# ------------------------------------------------------------------------------
#
#
# ------------------------------------------------------------------------------
serial_packages:
  metadata: { section: packages }
  pe: [gcc_stable, intel_stable]
  packages:
    - bwa
    - bzip2
    - cmake ~ncurses:
        dependencies:
          - openssl@<openssl_version>
    - fastqc
    - fftw +openmp ~mpi
    - fftw ~openmp ~mpi
    - gmp
    - gsl
    - gzip
    - hisat2@2.2.1
    - htslib
    - hwloc:
        default:
          variants:
            common: ~cairo ~gl ~libudev ~libxml2 ~netloc +pci
            gpu:
              nvidia: +cuda +nvml ~rocm
              none: ~cuda ~rocm ~nvml
              amd: +rocm ~cuda
    - intel-oneapi-tbb
    - jasper
    # - kokkos:
    #    variants: target=<target>
    #    default:
    #      variants:
    #        common: +openmp
    #        gpu:
    #          nvidia: +cuda +cuda_uvm cuda_arch=<cuda_arch> +wrapper
    #          none: ~cuda ~cuda_uvm ~rocm
    #    dependencies:
    #      common:
    #        - cmake +ownlibs target=<target>
    #      gpu:
    #        nvidia:
    #          - kokkos-nvcc-wrapper~mpi
    - libarchive
    - libfabric:
        default:
          variants:
            mpi:
              infiniband: fabrics=tcp,udp,sockets,mlx,verbs
              infiniband_gdrcopy: fabrics=tcp,udp,sockets,mlx,verbs
              ethernet_roce: fabrics=tcp,udp,sockets,mlx,verbs
              ethernet: fabrics=tcp,udp,sockets
    - libtiff
    - libxc
    - libxml2:
        default: { version: 2.9.13 }
    - mafft
    - metis:
        default: { variants: +real64 }
    - mpfr
    - muscle
    # ok syntax for namd
    #- namd:
    #    variants: interface=tcl
    #    dependencies:
    #      mpi:
    #        infiniband:
    #          - charmpp ~smp backend=verbs build-target=charm++ pmi=slurmpmi2
    - perl:
        default: { version: 5.32.0 }
    # This is already specified in the PE section
    # Here we are just making sure it will go into packages.yaml
    - python:
        variants: +tkinter +optimizations ~debug +ssl ~libxml2
        dependencies:
          - tk +xft +xss
        default:
          version: <python3>
          variants: +tkinter +optimizations ~debug +ssl ~libxml2
    - nfft ^fftw~mpi+openmp
    # - opengl:
    #     default:
    #       buildable: false
    #     externals:
    #       - spec: opengl@4.6
    #         prefix: /usr
    - openjdk:
        default:
          buildable: true
        externals:
          - spec: openjdk@<jdk_version>
            prefix: /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.352.b08-2.el9_0.x86_64
        modules:
          blacklist: True
    - openssl:
        default:
          version: <openssl_version>
          buildable: true
          variants: certs=system
        externals:
          - spec: openssl@<openssl_version> certs=system
            prefix: /usr
    - scotch:
        variants: ~mpi
        default: { variants: +esmumps ~metis }
    - stacks
    - star
    - subread
    - tcl
    - tk:
        default: { variants: +xft +xss }
        variants: +xft +xss
    - valgrind ~boost ~mpi
    - voropp
    - zlib

# GPU --------------------------------------------------------------------------
#
#
# ------------------------------------------------------------------------------
serial_packages_cuda:
  metadata: {section: packages }
  pe: [gcc_stable, intel_stable]
  filters: ['gpu = nvidia']
  packages:
    - cuda:
        default:
          version: 11.8.0


serial_packages_gpu:
  metadata: {section: packages }
  pe: [gcc_stable, intel_stable]
  filters: ['gpu = nvidia']
  dependencies: [gpu]
  packages:
    - cudnn:
        default:
          version: 8.7.0.84-11.8

serial_packages_gpu_gcc_stable:
  metadata: {section: packages }
  pe: [gcc_stable]
  filters: ['gpu = nvidia']
  dependencies: [gpu]
  packages:
    - nccl:
        default:
          variants: +cuda cuda_arch=<cuda_arch>

# GCC ONLY ---------------------------------------------------------------------
#
#
# ------------------------------------------------------------------------------
serial_packages_gcc_stable:
  metadata: { section: packages }
  pe: [gcc_stable]
  packages:
    - cistem target=<target> ^wxwidgets+libtiff ^fftw~mpi
    - ctffind target=<target> ^fftw~mpi
    - eigen:
        default: { variants: +ipo }
    - ffmpeg +libx264
    - glpk+gmp
    - hdf5:
        default:
          version: 1.12.2
          variants: ~mpi +cxx +fortran +hl +ipo +shared +szip +tools
    - intel-mkl
    - kallisto ^hdf5 ~mpi +ipo
    - libevent:
        default:
          buildable: false
        externals:
          - spec: libevent +openssl@2.1.12
            prefix: /usr
        module:
          blacklist: true
    - ncview:
        dependencies:
          - hdf5 ~mpi+szip+hl+fortran+cxx
          - netcdf-c ~mpi~parallel-netcdf
    - netcdf-c~mpi ^hdf5~mpi+szip+hl+fortran+cxx
    - netcdf-fortran ^netcdf-c~mpi ^hdf5~mpi+szip+hl+fortran+cxx
    - unblur target=<target> ^fftw~mpi
    - rdma-core:
        default:
          buildable: False
        externals:
          - spec: rdma-core@<rdma_core_version>
            prefix: /usr
    - rust:
        default:
          buildable: False
        externals:
          - spec: rust ~rls ~clippy ~rustfmt ~analysis ~src@1.58.1
            prefix: /usr
    - slurm:
        default:
          buildable: false
        externals:
          - spec: slurm@<slurm_version> ~mariadb
            prefix: /usr
    - sox
  # This package contains a deprecated variant: `cm`
    - ucx:
        default:
          variants:
            common: +parameter_checking +thread_multiple +cma
            mpi:
              infiniband: +rdmacm +rc +dc +ud +verbs +mlx5_dv
              infiniband_gdrcopy: +rdmacm +rc +dc +ud +verbs +mlx5_dv
              ethernet_roce: +rdmacm +rc +dc +ud +verbs +mlx5_dv
              ethernet: ~rdmacm ~rc ~dc ~ud ~verbs ~mlx5_dv
            gpu:
              nvidia: +gdrcopy +cuda cuda_arch=<cuda_arch>
              none: ~gdrcopy +cm

# INTEL ONLY ---------------------------------------------------------------------
#
#
# ------------------------------------------------------------------------------
serial_packages_intel_stable:
  metadata: { section: packages }
  pe: [intel_stable]
  packages:
    - abaqus@2019:
        default:
          buildable: false
          permissions:
            read: group
            group: abaqus-soft
        externals:
          - spec: abaqus@2019
            prefix: <external_prefix>/abaqus/2019
          - spec: abaqus@2023
            prefix: <external_prefix>/abaqus/2023
    - abaqus@2023
    - eigen ~ipo
    - hdf5~ipo
    - intel-oneapi-ipp
    - kallisto ^hdf5 ~mpi ~ipo ^cmake target=<target>
    - netcdf-c~mpi ^hdf5~ipo~mpi+szip+hl+fortran+cxx
    - netcdf-fortran ^netcdf-c~mpi ^hdf5~ipo~mpi+szip+hl+fortran+cxx

# BLAS -------------------------------------------------------------------------
#
#
# ------------------------------------------------------------------------------
serial_packages_blas:
  metadata:
    section: packages
  pe: [gcc_stable, intel_stable]
  dependencies: [blas]
  packages:
    - arpack-ng ~mpi
    - superlu

serial_packages_blas_gpu:
  metadata:
    section: packages
  pe: [gcc_stable, intel_stable]
  dependencies: [blas, gpu]
  packages:
    - suite-sparse:
        variants:
          gpu:
            nvidia: +cuda
            none: ~cuda
#    - magma:
#        variants:
#          gpu:
#            nvidia: +cuda cuda_arch=<cuda_arch>
#        dependencies:
#          - cmake +ownlibs

# BLAS (GCC ONLY) --------------------------------------------------------------
#
#
# ------------------------------------------------------------------------------
serial_packages_blas_gcc_stable:
  metadata: { section: packages }
  pe: [gcc_stable]
  dependencies: [blas]
  packages:
    - armadillo +hdf5 ^arpack-ng ~mpi ^hdf5 ~mpi
    - octave

# PYTHON ACTIVATED -------------------------------------------------------------
#
#
# ------------------------------------------------------------------------------
serial_packages_python_activated:
  metadata:
    section: packages
    modules:
      blacklist: True
    activated: True
  pe: [gcc_stable, intel_stable]
  dependencies: [python3]
  packages:
    - py-absl-py
    - py-astunparse
    - py-backports-entry-points-selectable
    - py-certifi
    - py-charset-normalizer
    - py-cycler
    - py-cython
    - py-distlib
    - py-filelock
    - py-gast
    - py-google-pasta
    - py-kiwisolver
    - py-idna
    - py-mpmath
    - py-packaging
    - py-pip
    - py-pillow
    - py-platformdirs
    - py-ply
    - py-protobuf
    - py-python-dateutil
    - py-pyparsing
    - py-pytz
    - py-requests
    - py-semver
    - py-six
    - py-sympy
    - py-termcolor
    - py-virtualenv
    - py-urllib3
    - py-wheel
    - py-wrapt

# PYTHON ACTIVATED - BLAS  -----------------------------------------------------
#
#
# ------------------------------------------------------------------------------
serial_packages_python_blas_activated:
  metadata:
    section: packages
    modules: { blacklist: True }
    activated: True
  pe: [gcc_stable, intel_stable]
  dependencies: [python3, blas_parallel]
  packages:
    - py-keras-preprocessing
    - py-matplotlib
    - py-numpy
    - py-opt-einsum
    - py-pandas
    - py-xarray

# PYTHON -----------------------------------------------------------------------
#
#
# ------------------------------------------------------------------------------
serial_packages_python:
  metadata:
    section: packages
  pe: [gcc_stable, intel_stable]
  dependencies: [python3]
  packages:
    - bedtools2
    - bowtie2 ^intel-oneapi-tbb
    - cairo:
        default: { variants: +png +pdf +fc +ft }
    - mercurial
    - ninja ^tk +xft+xss
    - prinseq-lite
    - py-pybind11
    - samtools
    - scons
    - snakemake

serial_packages_python_gcc_stable:
  metadata:
    section: packages
  pe: [gcc_stable]
  dependencies: [python3]
  packages:
    - angsd
    - curl@7.83.0
    - llvm@14.0.6:
        default:
          version: 14.0.6
          variants:
            common: +ipo
            gpu:
              nvidia: +cuda cuda_arch=<cuda_arch>
              none: ~cuda
    - llvm@15.0.2
    - py-pyem
    - py-grpcio:
       activated: True

# PYTHON BLAS ------------------------------------------------------------------
#
#
# ------------------------------------------------------------------------------
serial_packages_python_blas:
  metadata: { section: packages }
  pe: [gcc_stable, intel_stable]
  dependencies: [python3, blas_parallel]
  packages:
    - boost:
        default:
          variants: cxxstd=14 +icu ~mpi +python +numpy +atomic +chrono +container +date_time +filesystem +graph +iostreams ~json +locale +log +math ~pic +program_options +random +regex +serialization +shared +signals ~singlethreaded ~stacktrace +system ~taggedlayout +test +thread +timer ~type_erasure ~versionedlayout +wave +exception
    #- bcl2fastq2
    - py-biopython
    - py-macs2
    - py-pybigwig

serial_packages_python_blas_gcc_stable:
  metadata: { section: packages }
  pe: [gcc_stable]
  dependencies: [python3, blas_parallel]
  packages:
    - gmsh:
        variants: |
          ~mpi +hdf5 +cgns +eigen ~opencascade +openmp ~fltk ~med
        dependencies:
          - scotch ~mpi
          - cgns ~mpi
          - hdf5 ~mpi
          - mmg +ipo ~vtk
    - iq-tree +ipo@1.6.12
    - iq-tree +ipo@2.0.6
    - polymake ^cddlib@0.94h

    - py-deeptools
    - py-h5py ^hdf5 ~mpi +ipo:
        modules:
          autoload: direct
    - py-scikit-learn
    - py-scipy:
        activated: True
    - py-statsmodels
    - py-theano:
        variants:
          gpu:
            nvidia: +cuda cuda_arch=<cuda_arch>
            none: ~cuda
    - py-cryolobm
    - py-pymol

serial_packages_python_blas_intel_stable:
  metadata: { section: packages }
  pe: [intel_stable]
  dependencies: [python3, blas_parallel]
  packages:
    - gmsh:
        variants: |
          ~mpi +hdf5 +cgns +eigen ~opencascade +openmp ~fltk ~med
        dependencies:
          - scotch ~mpi
          - cgns ~mpi
          - hdf5 ~mpi ~ipo
          - mmg ~ipo ~vtk
    - iq-tree ~ipo@1.6.12
    - iq-tree ~ipo@2.0.6
    - py-h5py ^hdf5 ~mpi ~ipo:
        modules:
          autoload: direct


# PYTHON 2 ---------------------------------------------------------------------
#
#
# ------------------------------------------------------------------------------
serial_packages_python2_deprecated:
  metadata: { section: packages }
  pe: [gcc_stable, intel_stable]
  dependencies: [python2]
  packages:
    - jellyfish
    - scons
    - py-pip:
        activated: True
    - py-virtualenv:
        activated: True

# PYTHON - GCC ONLY ------------------------------------------------------------
#
#
# ------------------------------------------------------------------------------
serial_packages_python_gcc_stable:
  metadata: { section: packages }
  pe: [gcc_stable]
  dependencies: [python3]
  packages:
    - blast-plus
    - gdb +tui +source-highlight +lto +xz ^boost~mpi
    - libgd
    - julia+openlibm@1.8.3
    - node-js
    - mesa:
        default:
          variants: ~llvm
    - mummer
    - openbabel +python
    - r:
        default: {variants: +external-lapack}
    - gatk
    - spades
    - xgboost:
        variants:
          gpu:
            nvidia: +cuda cuda_arch=<cuda_arch>
            none: ~cuda

# PYTHON + GPU (GCC ONLY) ------------------------------------------------------
#
#
# ------------------------------------------------------------------------------
serial_packages_python_gpu_gcc_stable:
  metadata: { section: packages }
  pe: [gcc_stable]
  dependencies: [python3, gpu]
  packages:
    - caffe:
        variants:
          common: ~opencv +python
          gpu:
            nvidia: +cuda cuda_arch=<cuda_arch>
            none: ~cuda
        dependencies:
          - boost~mpi
    - julia+openlibm~precompile@1.10.0:
        dependencies:
          common: llvm~clang
          gpu:
            nvidia: [suite-sparse +cuda]
            none: [suite-sparse ~cuda]

# EXTERNAL ---------------------------------------------------------------------
#
# 
# ------------------------------------------------------------------------------
#
# This packages will be always written to packages.yaml and will always have the
# flag buildable: false. This type of information should be veiculated in the
# metadata section of the list and we should avoid repeat it for every package.
# In a second remark, these packages are already being written to packages.yaml
# even without expliciting the keyword `default`.
# IMO, `externals` keywork should be placed inside `default` keyword. In a more
# general way, it is the default keyword that sets a package to be written to
# packages.yaml.
external_packages:
  metadata:
    section: packages
  pe: [core]
  filters: ['cloud = none']
  packages:
    - ansys@2022R1:
        default:
          buildable: false
        externals:
          - spec: ansys@2020R2 %<core_compiler>
            prefix: <external_prefix>/ansys/2020R2/v202
          - spec: ansys@2022R1 %<core_compiler>
            prefix: <external_prefix>/ansys/2022R1/v221
          - spec: ansys@2022R2 %<core_compiler>
            prefix: <external_prefix>/ansys/2022R2/v222
    - ansys@2022R2
    - cfdplusplus:
        default:
          buildable: false
        externals:
        - spec: cfdplusplus@16.1 %<core_compiler>
          prefix: <external_prefix>/CFD++/2016.05
        - spec: cfdplusplus@19.1 %<core_compiler>
          prefix: <external_prefix>/CFD++/19.1
    - comsol:
        default:
          buildable: false
          permissions:
            read: group
            group: comsol-soft
        externals:
          - spec: comsol@5.6 %<core_compiler>
            prefix: <external_prefix>/comsol/5.6/comsol56/multiphysics/
          - spec: comsol@6.0 %<core_compiler>
            prefix: <external_prefix>/comsol/6.0
    - fdtd:
        default:
          buildable: false
          permissions:
            read: group
            group: fdtd-soft
        externals:
          - spec: fdtd@2020-R2-2387 %<core_compiler>
            prefix: <external_prefix>/fdtd/8.24.2387
          - spec: fdtd@2020-R2.4-2502 %<core_compiler>
            prefix: <external_prefix>/fdtd/2020-R2.4-2502
          - spec: fdtd@2021-R2.2-2806 %<core_compiler>
            prefix: <external_prefix>/fdtd/2021-R2.2-2806
          - spec: fdtd@2022-R1.1-2963 %<core_compiler>
            prefix: <external_prefix>/fdtd/2022-R1.1-2963

    - gurobi:
        default:
          buildable: false
        externals:
          - spec: gurobi@8.1.1 %<core_compiler>
            prefix: <external_prefix>/gurobi/8.1.1
          - spec: gurobi@9.5.2 %<core_compiler>
            prefix: <external_prefix>/gurobi/9.5.2
          - spec: gurobi@10.0.1 %<core_compiler>
            prefix: <external_prefix>/gurobi/10.0.1

    - gaussian:
        default:
          buildable: false
        externals::
          - spec: gaussian@g16-A.03 %<core_compiler>
            prefix: <external_prefix>/gaussian/g16-A.03/avx2
          - spec: gaussian@g16-C.01 %<core_compiler>
            prefix: <external_prefix>/gaussian/g16-C.01/avx2
    - matlab:
        default:
          buildable: false
        externals:
          - spec: matlab@R2018a %<core_compiler>
            prefix: <external_prefix>/MATLAB/R2018a
          - spec: matlab@R2019b %<core_compiler>
            prefix: <external_prefix>/MATLAB/R2019b
    - maple:
        default:
          buildable: false
        externals:
          - spec: maple@2017 %<core_compiler>
            prefix: <external_prefix>/Maple/2017
    - mathematica:
        default:
          buildable: false
        externals:
          - spec: mathematica@11.1.1 %<core_compiler>
            prefix: <external_prefix>/Mathematica/11.1.1
          - spec: mathematica@13.0 %<core_compiler>
            prefix: <external_prefix>/Mathematica/13.0
    - molpro:
        default:
          buildable: false
        externals:
          - spec: molpro@2022.3.0 %<core_compiler>
            prefix: <external_prefix>/molpro/2022.3.0/mpi
    - smr:
        default:
          buildable: false
        externals:
          - spec: smr@2017.0 %<core_compiler>
            prefix: <external_prefix>/SMR/2017.06
    - totalview:
        buildable: false
        externals:
          - spec: totalview@2017.2.11 %<core_compiler>
            prefix: <external_prefix>/toolworks/totalview.2017.2.11
          - spec: totalview@2020.3.11 %<core_compiler>
            prefix: <external_prefix>/toolworks/totalview.2020.3.11
#    - crystal17:
#        default:
#          buildable: true
#          permissions:
#            read: group
#            group: crystal-soft

# MPI --------------------------------------------------------------------------
#
#
# ------------------------------------------------------------------------------
mpi_packages:
  metadata:
    section: packages
  pe: [gcc_stable, intel_stable]
  dependencies:
    - mpi
  packages:
    - fftw:
        variants: +mpi +openmp
        default: { variants: +mpi ~openmp }
    - openfoam-org +metis ^scotch+mpi
    - phylobayesmpi
    - scotch +mpi ^flex ^gettext +libxml2

# MPI --------------------------------------------------------------------------
#
#
# ------------------------------------------------------------------------------
mpi_packages_gcc_stable:
  metadata:
    section: packages
  pe: [gcc_stable]
  dependencies:
    - mpi
  packages:
    - hdf5 +mpi +szip +hl +fortran +cxx
    - netcdf-c +mpi ^hdf5 +mpi +szip +hl +fortran +cxx
    - netcdf-fortran ^hdf5 +mpi +szip +hl +fortran +cxx
    - parmetis:
        default: { variants: +ipo }
    - wrf ~pnetcdf build_type=dm+sm ^netcdf-c +mpi ^netcdf-fortran

# MPI --------------------------------------------------------------------------
#
#
# ------------------------------------------------------------------------------
mpi_packages_intel_stable:
  metadata:
    section: packages
  pe: [intel_stable]
  dependencies:
    - mpi
  packages:
#    - adf:
#        default:
#          buildable: false
#          permissions:
#            read: group
#            group: adf-soft
#        externals:
#          - spec: adf@2017.11
#            prefix: <external_prefix>/adf/adf2017.111
    - hdf5 ~ipo +mpi +szip +hl +fortran +cxx
    - netcdf-c +mpi ^hdf5 ~ipo +mpi +szip +hl +fortran +cxx
    - netcdf-fortran ^hdf5 ~ipo +mpi +szip +hl +fortran +cxx
    - parmetis:
        default: { variants: ~ipo }

# MPI + BLAS -------------------------------------------------------------------
#
#
# ------------------------------------------------------------------------------
mpi_blas_packages_gcc_stable:
  metadata:
    section: packages
  pe:
    - gcc_stable
  dependencies:
    - mpi
    - blas
  packages:
    # - abinit +openmp +mpi +scalapack +wannier90:
    #     dependencies:
    #       - hdf5 +mpi
    #       - netcdf-c +mpi
    - gmsh +mpi +eigen +openmp +hdf5 ~fltk ~opencascade ~med:
        dependencies:
          - hdf5 +mpi
          - mmg +ipo ~vtk
    - cpmd@4.3 ~openmp
    - elmerfem +mumps +openmp +hypre:
        dependencies:
          - hdf5 +mpi
    - mumps:
        default: { variants: +mpi +parmetis +metis +scotch +ptscotch }
        dependencies:
          - scotch +mpi
          - netlib-scalapack
    - netlib-scalapack:
        default: { variants: +ipo }
    - quantum-espresso@7.2:
        variants: +mpi+scalapack+gipaw~cmake
        dependencies:
          - fftw+mpi+openmp
    - quantum-espresso@7.2:
        variants: +mpi+scalapack+gipaw~cmake hdf5=parallel
        dependencies:
          - fftw+mpi+openmp
    - superlu-dist:
        default:
          variants:
            common: +ipo
            gpu:
              nvidia: +cuda cuda_arch=<cuda_arch>
              none: ~cuda
    - yambo+mpi io=iotk,etsf-io ^fftw+mpi+openmp

# MPI + BLAS -------------------------------------------------------------------
#
#
# ------------------------------------------------------------------------------
mpi_blas_packages_intel_stable:
  metadata: { section: packages }
  pe: [intel_stable]
  dependencies: [mpi, blas]
  packages:
    - gmsh +mpi +eigen +openmp +hdf5 ~fltk ~opencascade ~med:
        dependencies:
          - hdf5 +mpi ~ipo
          - mmg ~ipo ~vtk
    - quantum-espresso@7.2:
        variants: +mpi+scalapack+gipaw~cmake
    - quantum-espresso@7.2:
        variants: +mpi+scalapack+gipaw~cmake hdf5=parallel
        dependencies:
          - hdf5 +mpi ~ipo
    - mumps:
        default: { variants: +mpi +parmetis +metis +scotch +ptscotch }
        dependencies:
          - scotch +mpi

mpi_blas_gpu_packages_intel_stable:
  metadata: { section: packages }
  pe: [intel_stable]
  dependencies: [mpi, blas, gpu]
  packages:
    - superlu-dist:
        default:
          variants:
            common: ~ipo
            gpu:
              nvidia: +cuda cuda_arch=<cuda_arch>
              none: ~cuda

# MPI + BLAS -------------------------------------------------------------------
#
#
# ------------------------------------------------------------------------------
mpi_blas_packages:
  metadata: { section: packages }
  pe: [gcc_stable, intel_stable]
  dependencies: [mpi, blas]
  packages:
    - arpack-ng:
        default: { variants: +mpi }
    - hypre:
        default:
          variants:
            gpu:
              nvidia: +cuda cuda_arch=<cuda_arch>
              none: ~cuda
    # - molpro:
    #     default:
    #       buildable: true
    #       permissions:
    #         read: group
    #         group: molpro-soft

mpi_blas_packages_licensed:
  metadata: { section: packages }
  pe: [gcc_stable, intel_stable]
  dependencies: [mpi, blas]
  filters: ['cloud = none']
  packages:
    - vasp@6.3.2:
        variants: +hdf5 +scalapack +shmem +wannier90
        default:
          buildable: true
          permissions:
            read: group
            group: vasp-soft
        dependencies:
          - hdf5 +mpi ~ipo
    - vasp@6.4.1:
        variants: +hdf5 +scalapack +shmem +wannier90
        default:
          buildable: true
          permissions:
            read: group
            group: vasp-soft
        dependencies:
          - hdf5 +mpi ~ipo

# MPI PYTHON --------------------------------------------------------------------
#
#
# ------------------------------------------------------------------------------
mpi_python_packages:
  metadata:
    section: packages
  pe: [gcc_stable, intel_stable]
  dependencies: [mpi, python3]
  packages:
    - py-mpi4py

# MPI + BLAS + PYTHON ----------------------------------------------------------
#
#
# ------------------------------------------------------------------------------
mpi_blas_python_packages:
  metadata:
    section: packages
  pe: [gcc_stable, intel_stable]
  dependencies: [mpi, blas, python3]
  packages:
    - boost +mpi
    - cgal ^boost+mpi
    - iq-tree@1.6.12+mpi ^boost+mpi
    - neuron +mpi +python
    - plumed:
        default: { variants: +mpi +gsl }

# MPI (GCC ONLY) ---------------------------------------------------------------
#
#
# ------------------------------------------------------------------------------
mpi_packages_gpu_gcc_stable:
  metadata: { section: packages }
  pe: [gcc_stable]
  dependencies: [mpi, gpu]
  filters: ["gpu"]
  packages:
    # - kokkos:
    #    variants: target=<target>
    #    default:
    #      variants:
    #        common: +openmp
    #        gpu:
    #          nvidia: +cuda +cuda_uvm cuda_arch=<cuda_arch> +wrapper
    #          none: ~cuda ~cuda_uvm ~rocm
    #    dependencies:
    #      common:
    #        - cmake +ownlibs target=<target>
    #      gpu:
    #        nvidia:
    #          - kokkos-nvcc-wrapper+mpi
    - relion@4.0.1 ~mklfft:
        variants:
          gpu:
            nvidia: +cuda cuda_arch=<cuda_arch> +double-gpu
            none: ~cuda
        dependencies:
          - fftw+mpi+openmp

# MPI BLAS PYTHON (GCC ONLY) ---------------------------------------------------
#
#
# ------------------------------------------------------------------------------
mpi_blas_python_packages_gcc_stable:
  metadata: { section: packages }
  pe: [gcc_stable]
  dependencies: [mpi, blas, python3]
  packages:
    - adios2:
        default: { variants: +hdf5 +mpi +python }
    # Cannot fetch
    # - amber +mpi:
    #     variants:
    #       gpu:
    #         nvidia: +cuda cuda_arch=<cuda_arch>
    #         none: ~cuda
    #     dependencies:
    #       - boost+mpi
    - fenics +parmetis +hdf5 +scotch +suite-sparse ~vtk ~trilinos:
        dependencies:
          common:
            - boost+mpi
            #- hdf5 +ipo +mpi +szip +hl +fortran +cxx
          gpu:
            nvidia: [petsc +cuda cuda_arch=<cuda_arch>, suite-sparse +cuda]
            none: []
    - gromacs@2021.4+mpi+plumed:
        variants:
          gpu:
            nvidia: +cuda
            none: ~cuda
        dependencies:
          - fftw~mpi+openmp
    - gromacs@2023+mpi+plumed:
        variants:
          gpu:
            nvidia: +cuda
            none: ~cuda
        dependencies:
          - fftw~mpi+openmp
    - lammps@20220107:
        variants:
          common: |
            build_type=Release +asphere +atc +body +class2 +colloid +compress
            +coreshell +dipole +diffraction +extra-dump +granular +h5md +kspace
            +latboltz +latte +lib +manybody +mc +misc +molecule +mpi +mpiio
            +netcdf +peri ~poems +python +qeq +replica +rigid +shock +ml-snap
            +srd +voronoi +plumed
          gpu:
            nvidia: +cuda cuda_arch=<cuda_arch>
            none: ~cuda
        dependencies:
          - netcdf-c+mpi
          - fftw+mpi+openmp
    - openfoam +metis ^boost+mpi ^hdf5+cxx+fortran+hl+ipo~java+mpi+shared+szip~threadsafe+tools ^fftw+mpi+openmp
    #- py-torch@1.11.0:
    #    variants:
    #      common: +mpi
    #      gpu:
    #        none: ~cuda
    #- py-torchvision:
    #    dependencies:
    #      gpu:
    #        none: [py-torch +mpi ~cuda]
    - opencv +vtk +python3:
        variants:
          gpu:
            nvidia: +cuda cuda_arch=<cuda_arch>
            none: ~cuda
        dependencies:
          - netcdf-c +mpi
          - boost+mpi
    - vtk:
        default:
          variants: +ffmpeg +python +xdmf +mpi ~qt +ipo +opengl2
          gpu:
            nvidia: ~osmesa
            none: +osmesa
        dependencies:
          - netcdf-c +mpi
          - boost+mpi

mpi_blas_python_packages_petsc_gcc_stable:
  metadata: { section: packages }
  pe: [gcc_stable]
  filters: ['gpu'] # This filter is only for backward compatibility
  dependencies: [mpi, blas, python3, gpu]
  packages:
    - petsc:
        default:
          variants:
            common:  ~int64 +double +hdf5 +metis +mpi +superlu-dist +hypre +suite-sparse
            gpu:
              nvidia: +cuda cuda_arch=<cuda_arch>
              none: ~cuda
        dependencies:
          common:
            - hdf5 +ipo +mpi
          gpu:
            nvidia: [suite-sparse +cuda]
            none: []
    - slepc:
        default: { variants: +arpack }
        dependencies:
          common:
            - hdf5 +ipo +mpi
          gpu:
            nvidia: [petsc +cuda cuda_arch=<cuda_arch>, suite-sparse +cuda]
            none: []
    - py-petsc4py:
        dependencies:
          common:
            - hdf5 +ipo +mpi
          gpu:
            nvidia: [petsc +cuda cuda_arch=<cuda_arch>, suite-sparse +cuda]
            none: []

mpi_blas_python_packages_no_gpu_gcc_stable:
  metadata: { section: packages }
  pe: [gcc_stable]
  filters: ['gpu = none']
  dependencies: [mpi, blas, python3, gpu]
  packages:
    - fenics-dolfinx +slepc:
        dependencies:
          common:
            - petsc
            - parmetis +ipo
            - superlu-dist +ipo
            - hdf5 +ipo +mpi
            - cmake +ownlibs

mpi_blas_parallel_python_gpu_packages_gcc_stable:
  metadata: { section: packages }
  pe: [gcc_stable]
  filters: ['gpu']
  dependencies: [mpi, blas_parallel, python3, gpu]
  packages:
    - eman2 +cuda +mpi:
        dependencies:
          - py-tensorflow +nccl@2.10.1
          - bazel
          - openjdk@11
          - hdf5 +mpi
          - cmake +ownlibs
    - py-keras:
        dependencies:
          - py-tensorflow +nccl@2.10.1
          - bazel
          - openjdk@11
          - hdf5 +mpi
          - cmake +ownlibs
    - py-horovod:
        default:
          variants:
            common: controllers=mpi frameworks=pytorch,tensorflow,keras
            gpu:
              nvidia: tensor_ops=nccl +cuda cuda_arch=<cuda_arch>
              none: tensor_ops=mpi ~cuda
        dependencies:
          - py-keras
          - py-tensorflow +nccl@2.10.1
          - bazel ^openjdk@11
          - hdf5 +mpi
          - cmake +ownlibs
          - py-torch +mpi +cuda cuda_arch=<cuda_arch>
    - py-tensorflow:
        default:
          version: 2.10.1
          variants:
            common: +mpi
            gpu:
              nvidia: +cuda cuda_arch=<cuda_arch> +nccl
              none: ~cuda ~nccl ~rocm
            networks:
              infiniband: +verbs
              infiniband_gdrcopy: +verbs
              ethernet_roce: ~verbs
              ethernet: ~verbs
        variants:
          common: +mpi
          gpu:
            nvidia: +cuda cuda_arch=<cuda_arch> +nccl
            none: ~cuda ~nccl ~rocm
        dependencies:
          - bazel ^openjdk@11
          - hdf5 +mpi
          - cmake +ownlibs
    - py-torch@2.0.1:
        variants:
          common: +mpi
          gpu:
            #nvidia: +cuda cuda_arch=<cuda_arch> +magma +cudnn +nccl
            nvidia: +cuda cuda_arch=<cuda_arch> ~magma +cudnn +nccl
            rocm: +magma +rocm
        default:
          version: 2.0.1
          variants:
            common: +mpi
            gpu:
              #nvidia: +cuda cuda_arch=<cuda_arch> +magma +cudnn +nccl
              nvidia: +cuda cuda_arch=<cuda_arch> ~magma +cudnn +nccl
              rocm: +magma +rocm
        dependencies:
          common:
            - cmake +ownlibs
          gpu:
            #nvidia: [magma +cuda cuda_arch=<cuda_arch>]
            nvidia: []
            none: []
            rocm: [magma +rocm amdgpuarch=<amd_arch>]
    - py-torchvision@0.15.2:
        dependencies:
          common:
            - cmake +ownlibs
          gpu:
            nvidia:
              - py-torch +mpi +cuda cuda_arch=<cuda_arch> ~magma
              #- py-torch +mpi +cuda cuda_arch=<cuda_arch> ~magma
              #- magma +cuda cuda_arch=<cuda_arch>
            none: [py-torch +mpi ~cuda]
    - py-topaz:
        variants:
          gpu:
            nvidia: +cuda cuda_arch=<cuda_arch>
            none: ~cuda
        dependencies:
          - cmake +ownlibs
          - py-torch +mpi +cuda cuda_arch=<cuda_arch>

mpi_blas_parallel_python_packages_gcc_stable:
  metadata: { section: packages }
  pe: [gcc_stable]
  dependencies: [mpi, blas_parallel, python3]
  packages:
    - paraview:
        default: { version: 5.10.1 }
        variants:
          common: +shared +python3 +hdf5
          gpu:
            nvidia: ~osmesa +opengl2
            rocm: ~osmesa
            none: +osmesa
        dependencies:
          - netcdf-c+mpi
#          - hdf5 +mpi +ipo
    - py-h5py ^hdf5 +mpi +ipo
    - cp2k@9.1 +mpi +plumed +openmp smm=blas:
        variants:
          gpu:
            nvidia: +cuda cuda_arch=<cuda_arch>
            none: ~cuda
        dependencies:
          - boost+mpi
          - fftw+mpi+openmp

mpi_blas_parallel_python_packages_intel_stable:
  metadata: { section: packages }
  pe: [intel_stable]
  dependencies: [mpi, blas_parallel, python3]
  packages:
    - py-h5py ^hdf5 ~ipo +mpi

mpi_blas_parallel_python_packages_intel_stable:
  metadata: { section: packages }
  pe: [intel_stable]
  dependencies: [mpi, blas_parallel, python3]
  packages:
    - py-h5py ^hdf5 ~ipo +mpi

mpi_blas_python_packages_intel_stable:
  metadata: { section: packages }
  pe: [intel_stable]
  dependencies: [mpi, blas, python3]
  packages:
    - petsc:
        default:
          variants:
            common:  ~int64 +double +hdf5 +metis +mpi +superlu-dist +hypre +suite-sparse
            gpu:
              nvidia: +cuda cuda_arch=<cuda_arch>
              none: ~cuda
        dependencies:
          common:
            - hdf5 ~ipo +mpi +szip +hl +fortran +cxx
          gpu:
            nvidia: [suite-sparse +cuda]
            none: []
    - slepc:
        default: { variants: +arpack }
        dependencies:
          common:
            - hdf5 ~ipo +mpi +szip +hl +fortran +cxx
          gpu:
            nvidia: [petsc +cuda cuda_arch=<cuda_arch> ,suite-sparse +cuda]
            none: []
    - py-petsc4py:
        dependencies:
          common:
            - hdf5 ~ipo +mpi +szip +hl +fortran +cxx
          gpu:
            nvidia: [petsc +cuda cuda_arch=<cuda_arch>, suite-sparse +cuda]
            none: []
    # - fenics-dolfinx +slepc:
    #     dependencies:
    #       common:
    #         - hdf5 ~ipo +mpi
    #       gpu:
    #         nvidia: [petsc +cuda cuda_arch=<cuda_arch>, suite-sparse +cuda]
    #         none: []



# BENCHMARKS -------------------------------------------------------------------
#
#
# ------------------------------------------------------------------------------
benchmarks:
  metadata: { section: packages }
  pe: [gcc_stable, intel_stable]
  packages:
    - stream
    - stream+openmp

mpi_benchmarks:
  metadata: { section: packages }
  pe: [gcc_stable, intel_stable]
  dependencies: [mpi]
  packages:
    - osu-micro-benchmarks
    - hp2p

mpi_blas_benchmarks:
  metadata: { section: packages }
  pe: [gcc_stable, intel_stable]
  dependencies: [mpi, blas]
  packages:
    - hpl~openmp
    - hpl+openmp
